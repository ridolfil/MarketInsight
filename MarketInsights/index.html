<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Market Insight</title>

    <link href="http://cdn.kendostatic.com/2014.2.716/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2014.2.716/styles/kendo.bootstrap.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2014.2.716/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2014.2.716/styles/kendo.dataviz.bootstrap.min.css" rel="stylesheet" />

    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.kendostatic.com/2014.2.716/js/kendo.all.min.js"></script>
    <script src="http://cdn.kendostatic.com/2014.2.716/js/kendo.timezones.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css\bootstrap.min.css" type="text/css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="css\bootstrap-theme.css" type="text/css">

    <link rel="stylesheet" href="css\starter-template.css" type="text/css" dir="ltr">

</head>
<body>
    <div class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Market Insight</a>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-10" id="grid_container">
                <div id="grid">
                    <script src="js\data.js"></script>
                    <script>
                        if (!String.prototype.format) {
                            String.prototype.format = function () {
                                var args = arguments;
                                return this.replace(/{(\d+)}/g, function (match, number) {
                                    return typeof args[number] != 'undefined'
                                      ? args[number]
                                      : match
                                    ;
                                });
                            };
                        }

                        $(document).ready(function () {



                            //var url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quote%20where%20symbol%20in%20(%22%5EGSPC%22%2C%22AAPL%22%2C%22GOOG%22%2C%22MSFT%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";
                            var url = "https://query.yahooapis.com/v1/public/yql?q=select%20Name%2CSymbol%2CDaysLow%2CDaysHigh%2CChangeinPercent%2CChange%2CLastTradePriceOnly%20%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22%5EFCHI%22%2C%22%5EGDAXI%22%2C%22FTSEMIB.MI%22%2C%22%5EFTSE%22%2C%20%22%5EGSPC%22%2C%20%22IBEX%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&";

                            //$.getJSON(url, function (o) {
                            //    debugger;
                            //    gridData = o.query.results.quote;



                            //});

                            var gridData = new kendo.data.DataSource({
                                transport: {
                                    read: {
                                        url: url,
                                        dataType: "jsonp"
                                    }
                                },
                                schema: {
                                    parse: function (data) {
                                        return data.query.results.quote;
                                    },
                                    data: function (data) {
                                        debugger;
                                        $.each(data, function () {
                                            if (this.Change != null) {
                                                if (this.Change.indexOf("-") > -1) {
                                                    this.Change += " <i class='fa fa-caret-down fa-1.5x' style='color:red'></i>";
                                                } else {
                                                    this.Change += " <i class='fa fa-caret-up fa-1.5x' style='color:green'></i>";

                                                }
                                            }
                                        });

                                        return (data);
                                    }
                                }

                            });




                            gridData.fetch(function () {

                                $("#grid").kendoGrid({
                                    columns: [
                                        {
                                            title: "Name",
                                            field: "Name"
                                        },
                                        {
                                            title: "Close",
                                            field: "LastTradePriceOnly"
                                        },
                                        {
                                            title: "Change Net",
                                            field: "Change",
                                            encoded: false,
                                            attributes: {
                                                style: "text-align: right"
                                            }
                                        },
                                        {
                                            title: "High",
                                            field: "DaysHigh"
                                        },

                                         {
                                             title: "Low",
                                             field: "DaysLow"
                                         }

                                    ],
                                    selectable: true,
                                    change: showSelection,
                                    dataSource: gridData

                                });
                                debugger;
                                var grid = $("#grid").data("kendoGrid");
                                grid.select("tr:eq(1)");

                            });
                        });

                           

                        function showSelection(e) {
                            var grid = $("#grid").data("kendoGrid");
                            var t = grid.dataItem(this.select());

                            $("#test").text(t.Name);

                           createChart(t);
                        }

                       
                    </script>

                   
                </div>
                
                <h4 id="test"></h4>
                <div id="chart"></div>
               <!-- <script type="text/javascript" src="https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.historicaldata%20where%20symbol%20%3D%20%22%5EGSPC%22%20and%20startDate%20%3D%20%222014-07-1%22%20and%20endDate%20%3D%20%222014-07-31%22&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=showQuery"></script>-->
                <script>

                 

                    function createChart(o) {

                        var urlFormat = "https://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.historicaldata where symbol = '{0}' and startDate = '{1}' and endDate = '{2}'&format=json&env=store://datatables.org/alltableswithkeys";
                        var url = urlFormat.format(o.Symbol, '2014-03-1', '2014-07-31')

                        var d = new kendo.data.DataSource({
                            transport: {
                                read: {
                                    url: url,
                                    dataType: "jsonp"
                                }
                            },
                            schema: {
                                parse: function (data) {
                                    return data.query.results.quote;
                                }
                            }
                        });

                        debugger;
                        $("#chart").empty();
                        $("#chart").kendoChart({
                            dataSource:d,
                            seriesDefaults: {
                                type: "area",
                                area: {
                                    line: {
                                        style: "smooth"
                                    }
                                }
                            },
                            categoryAxis: {
                                majorGridLines: {
                                    visible: false
                                }
                            },
                            tooltip: {
                                visible: true,
                                format: "{0}",
                                //template: "value #"
                            },
                            legend: {
                                visible: false
                            },
                            series: [{
                                field: "Close"
                            }]
                        });
                    }


                    //function changeChart() {
                    //    var chart = $("#chart").data("kendoChart");

                    //    var d = new kendo.data.DataSource({
                    //        data: test_data
                    //    }
                    //    )

                    //    chart.setDataSource(d);

                    //}


                    //function showQuery(o) {


                    //    var place = $("#chart");
                    //    var items = o.query.results.quote;


                    //    var g = "<p>prova prova<\p>";
                    //    place.append($("<p><\p>").text(items[0].Symbol));
                    //    place.append(g);

                    //    for (var i = 0; i < items.length; i++) {
                    //        place.append($("<p><\p>").text(items[i].Close));
                    //    }
                    //}

                    //$(document).ready(function () {
                    //    var place = $("#chart");
                    //    //var items = o.query.results.quote;

                    //    //place.append($("h4").text(items[0].Symbol))
                    //    place.html("<p>This is a test.</p>");

                    //})

                </script>



            </div>
        </div>
    </div>

    <script src="js\bootstrap.min.js"></script>
</body>
</html>